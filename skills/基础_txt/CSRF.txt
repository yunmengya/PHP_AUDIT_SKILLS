PHP 代码审计之 CSRF( 客户端请求伪造 )  
1.CSRF 原理  
  CSRF （ Cross-site request forgery ），中文名称：跨站请求伪造，也被称为：客户端请求伪造。在
CSRF 的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，
用户一旦点击了这个请求，整个攻击就完成了。所以 CSRF 攻击也成为 "one click" 攻击。
1.1 CSRF 与 SSRF 的区别？  
  这个问题也是在面试中常被问到的一个问题，我在前两年参加工作的时候也被问到过这个问题。其
实问题很简单，大家只要了解 CSRF 与 SSRF 的本质区别就很容易理解。
  CSRF 相当于我们欺骗的是客户端，在直白一点来说的话我们欺骗的是目标用户，通过构造恶意请求
页面诱使用户去点击从而触发恶意请求达到我们的目的，而 SSRF 如果大家看了我 2.6 的内容的话，大家
其实就知道 SSRF 相当于我们利用的是服务器，我们通过存在 SSRF 漏洞的服务器向内网主机发送恶意请求
来达到我们的目的。
  一句话来说 CSRF 伪造的是客户端也就是欺骗的是用户，而 SSRF 伪造的则是服务器请求，欺骗的是
内网主机或者内网服务器。
2.CSRF 危害  
  攻击者盗用你的身份令牌以正常用户的身份发送恶意的请求，例如修改密码、添加用户、转账、购
买商品、也可配合 XSS 打组合拳获取管理员登录凭证等一些敏感操作。
场景：
攻击者在不知道后台登录密码的情况下想要直接修改 XXX 网站的后台登录密码。
正常的修改密码操作：
具有修改权限的用户登录 XXX 网站后台，在修改密码功能处进行密码修改。
假设我们可以正常注册一个用户，然后登录后台，在修改密码处发现 POST 请求包内容如下
3.CSRF 攻击方式  
3.1 GET 方式 CSRF 利用  
当一个危险请求是通过 GET 方式传输的，且其中参数容易被攻击者进行伪造，那么该功能点处就可能存
在 CSRF 。
例如：修改密码为http://XXXXXX.com/changepwd.php?user=ceshi&newpwd=XXXX&repeatpwd=XXX
X&change=change
由于该链接无 token 保护且无任何防护，此时该链接可被伪造，将构造好的链接如：http://XXXXXX.co
m/changepwd.php?user=admin&newpwd=123456&repeatpwd=123456&change=change发送给目
标用户点击就会触发 CSRF, 修改该用户的密码。我们也可以将该链接生成一个短链接来进一步诱骗用户点
击，短链接生成网上有很多，例如：

接下来我们使用 2.7 节搭建起来的pikachu 靶场来演示一下 GET 型 CSRF 的效果
http://www.xxx.com/changepwd.php?change=change
请求内容为
user=ceshi&newpwd=XXXX&repeatpwd=XXXX
由于请求包中没有任何校验内容，容易被攻击者伪造且该用户正处于登录状态下。当用户成功点击就相当于使
用该用户的凭证去执行了我们想要执行的操作，所以我们就可以伪造该请求页面让从而诱使用户去点击从而修
改别人的后台登录密码。
首先我们来到对应的 CSRF GET 模块 , 其中存在 vince/allen/kobe/grady/kevin/lucy/lili 密码都是 123456 ，
我们登录 vince 用户。
在修改个人信息处抓包发现该处功能点是 GET 方式传输并在参数中没有任何校验，这就造就了 CSRF 。
我们将修改个人信息的请求包提取出来http://www.pikaqiu.com/vul/csrf/csrfget/csrf_get_edit.php?se
x=boy&phonenum=18626545453&add=chain&email=vince%40pikachu.com&submit=submit，例
如当前用户 lili 正在登录系统进行操作
我们通过上述构造的数据包诱使正在登录系统的 lili 去点击，当 lili 点击了攻击者构造好的 URL, 就会在 lili 在
知情的情况下，将 lili 的个人信息修改。
我们可以观察一个修改个人信息的代码csrf_get_edit.php
代码示例：
在代码 22-26 行判断了该用户是否登录如果没有登录则跳转到登录页面 csrf_get_login.php
在代码 31 行通过 get 接收 sex 、 phonenum 、 add 、 email 四个参数 , 在代码 33-36 行对传入的内容保存到数
据库中，在这个过程中没有任何的 token 以及 refer 等校验所以存在 CSRF 。
在代码 65-88 行将当前登录的 session 用户进行查询并返回该用户的相应个人信息。
3.2 POST 方式 CSRF 利用  
当一个危险请求是通过 POST 方式传输，且其中参数容易被攻击者进行伪造，那么该功能点处就可能造成
CSRF 。
我们还是使用 pikachu 靶场进行演示分析
我们还是登录 vince 用户，在修改个人信息处抓包发现该处功能点是以 POST 传递数据并数据包中没有
token 进行校验。
由于需要 POST 传递数据所以我们无法使用 URL 来伪造请求，我们可通过 Burp 对生成该请求的 CSRF 代
码。
如下就是通过 Burp 生成的该请求 CSRF 前端代码，我们只需要将该请求放入 HTML 中让 lili 用户去点击，也
会达到同样修改 lili 个人信息的效果。
设置我们想要修改的参数
当 lili 点击了攻击者精心构造的 html 文件， lili 的个人信息将被修改。

lili 在登录情况下点击了左边 html ，个人信息就被修改了。
我们可以观察一个修改个人信息的代码csrf_post_edit.php
代码示例：
代码中唯一的区别就在于 31 行处传递参数是以 POST 方式传递的，在这个过程中也没有任何的 token 以及
refer 等校验所以造成 CSRF 。
4.CSRF 代码审计  
  在对 CSRF 进行代码审计的时候，其实主要观察该危险功能处是否存在 token 或者其他校验，由于
CSRF 成因是因为攻击者可以很容易的伪造该功能页面然后诱骗用户去点击，如果参数中存在攻击者无法
伪造的内容则就不会存在 CSRF 。
  其实 CSRF 漏洞不用特别关注 PHP 代码，只需要在重要功能点处抓包查看其中是否存在攻击者不可伪
造的内容，如随机的 tonken 值或者验证码等等。然后在 PHP 代码中查看该 token 是如何进行逻辑校验的
即可。
5.CSRF 代码审计总结  

在关于 CSRF 代码审计中，我们不用将关注重点放在后端代码中，只需要关注一些危险功能点请求包或者请求内
容中是否存在攻击者无法伪造的内容即可。 CSRF 可以配合 XSS 进行组合拳将危害最大化，如腾讯某分站
ssrf+self xss 、联想某处 csrf+selfxss 存储型跨站漏洞等等，感兴趣的小伙伴可以在 baidu 自行搜索。